<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnglishStudy</title>
    <style>
        :root { --primary: #2563eb; --success: #059669; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 650px; margin: auto; }
        
        /* 共通ヘッダー */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .view { display: none; }
        .active { display: block; }

        /* ダッシュボード */
        .set-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .set-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .set-info h3 { margin: 0; font-size: 1rem; }
        .set-info span { font-size: 0.8rem; color: #64748b; }
        .status-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        .status-unsolved { background: #dbeafe; color: #1e40af; }
        .status-solved { background: #dcfce7; color: #166534; }

        /* 学習ビュー */
        .solve-header { position: sticky; top: 0; background: white; padding: 15px; margin: -20px -20px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .passage { background: white; padding: 20px; border-radius: 10px; border: 1px solid #e2e8f0; line-height: 1.6; white-space: pre-wrap; margin-bottom: 20px; }
        .q-card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
        .opt-btn { width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 8px; background: white; text-align: left; margin-bottom: 8px; cursor: pointer; }
        .opt-btn.selected { border-color: var(--primary); background: #eff6ff; }
        .opt-btn.correct { background: #dcfce7 !important; border-color: var(--success) !important; color: #166534; }
        .opt-btn.wrong { background: #fee2e2 !important; border-color: #dc2626 !important; }

        /* フッター */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; }
        .btn-grade { background: var(--success); color: white; }
        .btn-back { background: #64748b; color: white; }
        /* 表形式対応 */
        .passage-table-wrapper {
            width: 100%;
            overflow-x: auto; /* スマホで横スクロール可能に */
            margin: 15px 0;
        }
        .passage-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
        }
        .passage-table th, .passage-table td {
            border: 1px solid #cbd5e1;
            padding: 8px;
            text-align: left;
        }
        .passage-table th {
            background: #f1f5f9;
            font-weight: bold;
        }
        .passage-table-footer {
            text-align: right;
            font-weight: bold;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-top: none;
            background: #f8fafc;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="view-dashboard" class="view active">
        <div class="app-header">
            <h2>英語勉強用</h2>
            <div id="overall-stats" style="font-size: 0.9rem;"></div>
        </div>
        <div id="set-list">読み込み中...</div>
    </div>

    <div id="view-solve" class="view">
        <div class="solve-header">
            <button onclick="showDashboard()" style="border:none; background:none; color:var(--primary); cursor:pointer;">← 戻る</button>
            <div id="timer" style="font-family:monospace; font-size:1.4rem; font-weight:bold;">00:00</div>
            <div id="target-label" style="font-size:0.8rem; color:#64748b;"></div>
        </div>
        <div id="solve-content"></div>
        <div class="footer">
            <button class="btn btn-back" onclick="showDashboard()">一覧に戻る</button>
            <button class="btn btn-grade" id="grade-btn" onclick="gradeCurrentSet()">採点する</button>
        </div>
    </div>
</div>

<script>
    let allSets = [];
    let currentSet = null;
    let timerInterval;
    let startTime;
    let solvedIds = JSON.parse(localStorage.getItem('solved_v4') || "[]");
    let userSelections = {};

    async function init() {
        try {
            const res = await fetch('questions.json');
            allSets = await res.json();
            renderDashboard();
        } catch (e) { document.getElementById('set-list').innerText = "データ読み込み失敗"; }
    }

    function renderDashboard() {
        const list = document.getElementById('set-list');
        
        // ソート：未着手を優先
        const sortedSets = [...allSets].sort((a, b) => {
            const aDone = isSetSolved(a);
            const bDone = isSetSolved(b);
            return aDone === bDone ? 0 : aDone ? 1 : -1;
        });

        list.innerHTML = sortedSets.map(set => {
            const done = isSetSolved(set);
            const qCount = set.questions ? set.questions.length : 1; // 設問数
            const type = set.passages ? 'トリプル' : (set.passage ? '長文' : '単発');

            return `
                <div class="set-card" onclick="startSet('${set.id}')">
                    <div class="set-info">
                        <div style="font-size:0.7rem; color:var(--primary); font-weight:bold;">${set.category} [${type}]</div>
                        <h3>${set.title}</h3>
                        <span>設問数: ${qCount} | 目標: ${Math.floor(set.target_time_sec/60)}分${set.target_time_sec%60}秒</span>
                    </div>
                    <div class="status-badge ${done ? 'status-solved' : 'status-unsolved'}">
                        ${done ? '完了' : '未着手'}
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('overall-stats').innerText = `完了: ${allSets.filter(isSetSolved).length} / ${allSets.length}`;
        switchView('view-dashboard');
    }

    function isSetSolved(set) {
        // 設問が配列ならそのすべてが解決済みか、単発ならそのIDが解決済みかを返す
        const qs = set.questions || [set];
        return qs.every(q => solvedIds.includes(q.id));
    }
    function startSet(setId) {
            currentSet = allSets.find(s => s.id === setId);
            userSelections = {};
            const content = document.getElementById('solve-content');
            
            let passageHtml = '';
            const ps = currentSet.passages || (currentSet.passage ? [{type: 'text', content: currentSet.passage}] : []);

            ps.forEach((p, i) => {
                if (typeof p === 'string') {
                    passageHtml += `<div class="passage">${p}</div>`;
                } else if (p.type === 'text') {
                    passageHtml += `<div class="passage">${p.content}</div>`;
                } else if (p.type === 'table') {
                    let tableHtml = `<div class="passage-table-wrapper">`;
                    if (p.title) tableHtml += `<div style="font-weight:bold; margin-bottom:5px;">${p.title}</div>`;
                    tableHtml += `<table class="passage-table">`;
                    if (p.header) {
                        tableHtml += `<thead><tr>${p.header.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
                    }
                    tableHtml += `<tbody>${p.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>`;
                    tableHtml += `</table>`;
                    if (p.footer) tableHtml += `<div class="passage-table-footer">${p.footer}</div>`;
                    tableHtml += `</div>`;
                    passageHtml += tableHtml;
                }
            });

            // --- 修正ポイント：IDの付与とプロパティ名の修正 ---
            const qs = currentSet.questions || [currentSet];
            content.innerHTML = passageHtml + qs.map((q, i) => `
                <div class="q-card">
                    <div class="q-text" style="font-weight:bold; margin-bottom:10px;">
                        Q${i + 1}. ${q.q || "問題文がありません"}
                    </div>
                    <div class="options" id="opts-${q.id}">
                        ${(q.options || []).map((opt, optIdx) => `
                            <button class="opt-btn" id="btn-${q.id}-${optIdx}" onclick="selectOption('${q.id}', ${optIdx})">
                                (${String.fromCharCode(65 + optIdx)}) ${opt}
                            </button>
                        `).join('')}
                    </div>
                    <div id="exp-${q.id}" style="display:none; margin-top:10px; font-size:0.9rem; background:#fefce8; padding:10px; border-radius:5px;">
                        <strong>解説:</strong> ${q.explanation || "解説はありません"}
                    </div>
                </div>
            `).join('');

            document.getElementById('target-label').innerText = `目標: ${currentSet.target_time_sec}秒`;
            switchView('view-solve');
            
            startTime = Date.now();
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 100);
        }
    function selectOption(qId, oIdx) {
        userSelections[qId] = oIdx;
        const container = document.getElementById(`opts-${qId}`);
        container.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(`btn-${qId}-${oIdx}`).classList.add('selected');
    }

    function updateTimer() {
        const sec = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('timer').innerText = 
            `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
    }

    function gradeCurrentSet() {
        clearInterval(timerInterval);
        const finalTime = Math.floor((Date.now() - startTime) / 1000);
        const qs = currentSet.questions || [currentSet];
        
        qs.forEach(q => {
            const selected = userSelections[q.id];
            const correctBtn = document.getElementById(`btn-${q.id}-${q.answer}`);
            correctBtn.classList.add('correct');
            if (selected !== undefined && selected !== q.answer) {
                document.getElementById(`btn-${q.id}-${selected}`).classList.add('wrong');
            }
            if (selected === q.answer && !solvedIds.includes(q.id)) {
                solvedIds.push(q.id);
            }
            document.getElementById(`exp-${q.id}`).style.display = 'block';
        });

        localStorage.setItem('solved_v4', JSON.stringify(solvedIds));
        const status = finalTime <= currentSet.target_time_sec ? "目標達成！" : "時間超過";
        alert(`タイム: ${document.getElementById('timer').innerText}\n${status}`);
    }

    function showDashboard() {
        clearInterval(timerInterval);
        renderDashboard();
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        window.scrollTo(0,0);
    }

    init();
</script>
</body>
</html>